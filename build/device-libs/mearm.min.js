/*! mime-app-libs 2017-09-20 */
var MimeDevice=function(a){this.url=a,a&&this.connect(),this.cbs={},this.listeners=[],this.connected=!1,this.error=!1,this.timeoutTimer=void 0,this.devices={},this.discoveryURL=void 0,this.deviceState="idle",this.msg_stack=[],this.immediateCmds=["stop","pause","resume","ping","version"],this.connect=function(a){if(a&&(this.url=a),!this.connected&&!this.error&&this.url){var b=this;this.has_connected=!1,this.ws=new WebSocket(this.url),this.ws.onmessage=function(a){b.handle_msg(a)},this.ws.onopen=function(){b.connected=!0,b.version(function(){b.setConnectedState(!0)})},this.ws.onerror=function(a){b.handleError(a)},this.ws.onclose=function(a){b.handleError(a)},this.connTimeout=window.setTimeout(function(){b.connected||b.ws.close()},1e3)}},this.fetchDevices=function(a){if(!this.discoveryURL)return a(!1);var b=this,c=new XMLHttpRequest;c.addEventListener("load",function(){var c=JSON.parse(this.responseText);if(c.devices&&c.devices.length>0){for(var d=0;d<c.devices.length;d++)b.devices[c.devices[d].address]=c.devices[d];a(b.devices)}}),c.addEventListener("error",function(a){console.log("Error fetching devices list"),console.log(a)}),c.open("GET",this.discoveryURL),c.send()},this.disconnect=function(){this.connected=!1,this.error=!1,this.ws.onerror=function(){},this.ws.onclose=function(){},this.ws.close()},this.setConnectedState=function(a){var b=this;clearTimeout(b.connTimeout),b.connected=a,a&&(b.has_connected=!0),setTimeout(function(){b.emitEvent("readyStateChange",{state:b.ready()?"ready":"notReady"}),b.emitEvent("connectedStateChange",{state:b.connected?"connected":"disconnected"})},500),a?b.reconnectTimer&&(clearTimeout(b.reconnectTimer),b.reconnectTimer=void 0):b.reconnectTimer||(b.reconnectTimer=setTimeout(function(){b.reconnectTimer=void 0,b.connect()},5e3))},this.setSimulator=function(a){this.sim=a},this.setSimulating=function(a){this.simulating=a,this.emitEvent("readyStateChange",{state:this.ready()?"ready":"notReady"})},this.ready=function(){return this.connected||this.simulating},this.emitEvent=function(a,b){if(void 0!==this.listeners[a])for(var c=0;c<this.listeners[a].length;c++)this.listeners[a][c](b)},this.addEventListener=function(a,b){this.listeners[a]=this.listeners[a]||[],this.listeners[a].push(b)},this.handleError=function(a){a instanceof CloseEvent||"Timeout"===a?(this.ws.readyState===WebSocket.OPEN&&this.ws.close(),this.msg_stack=[]):console.log(a),this.setConnectedState(!1)},this.send=function(a,b){a.id=Math.random().toString(36).substr(2,10),b&&(this.cbs[a.id]=b),a.arg&&(a.arg=a.arg.toString()),this.immediateCmds.indexOf(a.cmd)>=0?this.send_msg(a):(0===this.msg_stack.length&&this.emitEvent("programStart"),this.msg_stack.push(a),this.process_msg_queue())},this.send_msg=function(a){var b=this;console.log(a),this.simulating&&this.sim?this.sim.send(a,function(a){b.handle_msg(a)}):this.connected&&(this.ws.send(JSON.stringify(a)),this.timeoutTimer&&clearTimeout(this.timeoutTimer),this.timeoutTimer=window.setTimeout(function(){b.handleError("Timeout")},3e3))},this.process_msg_queue=function(){"idle"===this.deviceState&&this.msg_stack.length>0&&(this.deviceState="receiving",this.send_msg(this.msg_stack[0]))},this.handle_msg=function(a){if("object"==typeof a&&"string"==typeof a.data&&(a=JSON.parse(a.data)),console.log(a),clearTimeout(this.timeoutTimer),"notify"===a.status)return void this.emitEvent(a.id,a.msg);this.msg_stack.length>0&&this.msg_stack[0].id==a.id?"accepted"===a.status?(this.cbs[a.id]&&this.cbs[a.id]("started",a),this.deviceState="running"):"complete"===a.status&&(this.cbs[a.id]&&(this.cbs[a.id]("complete",a),delete this.cbs[a.id]),this.msg_stack.shift(),0===this.msg_stack.length&&this.emitEvent("programComplete"),this.deviceState="idle",this.process_msg_queue()):this.cbs[a.id]&&(this.cbs[a.id]("complete",a),delete this.cbs[a.id]),a.status&&"error"===a.status&&"Too many connections"===a.msg&&(this.error=!0,this.emitEvent("error"))},this.stop=function(a){var b=this;this.send({cmd:"stop"},function(c,d,e){if("complete"===c&&!e){for(var f in b.cbs)b.cbs[f]("complete",void 0,!0);b.emitEvent("programComplete"),b.robot_state="idle",b.msg_stack=[],b.cbs={},a&&a(c)}})},this.addCmd=function(a){this[a]=function(b,c){var d={cmd:a};void 0!==c&&(d.arg=c),this.send(d,b)}},this.addCmd("ping"),this.addCmd("version")},MeArm=function(a){MimeDevice.call(this,a),this.addCmd("openGrip"),this.addCmd("closeGrip"),this.addCmd("moveBaseTo"),this.addCmd("moveLowerTo"),this.addCmd("moveUpperTo"),this.addCmd("moveGripTo"),this.addCmd("getServoState")};